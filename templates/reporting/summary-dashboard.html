{% extends "base.html" %}
{% block content %}

<div class="top-bar">
    <div>
        Welcome, {{ request.user.username }}
    </div>
    <div>
        <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
    </div>
</div>

<div class="container mt-4">

<!-- ===============================
     Header + Filters
================================= -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Estate Management Dashboard</h2>

    <form method="get" class="d-flex gap-2">

        <!-- Year -->
        <select name="year" class="form-select"
                onchange="this.form.submit()">
            {% for year in years_list %}
                <option value="{{ year }}"
                    {% if year == selected_year %}selected{% endif %}>
                    {{ year }}
                </option>
            {% endfor %}
        </select>

        <!-- Month -->
        <select name="month" class="form-select"
                onchange="this.form.submit()">
            <option value="">All Months</option>
            {% for num, name in months_list %}
                <option value="{{ num }}"
                    {% if num|stringformat:"s" == selected_month|stringformat:"s" %}selected{% endif %}>
                    {{ name }}
                </option>
            {% endfor %}
        </select>

    </form>
</div>

<!-- ===============================
     SUMMARY CARDS
================================= -->
<div class="row g-4 mb-4">

    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-primary text-white h-100">
            <div class="card-body">
                <h6>Total Reports</h6>
                <h3>{{ total_reports }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-warning text-dark h-100">
            <div class="card-body">
                <h6>Pending Reports</h6>
                <h3>{{ pending_reports }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-success text-white h-100">
            <div class="card-body">
                <h6>Resolved Reports</h6>
                <h3>{{ resolved_reports }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-danger text-white h-100">
            <div class="card-body">
                <h6>Total Fines Collected</h6>
                <h3>${{ total_fines }}</h3>
            </div>
        </div>
    </div>

</div>

<!-- ===============================
     CHARTS
================================= -->
<div class="row g-4">

    <!-- Monthly Bar Chart -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white">
                Monthly Reports Overview ({{ selected_year }})
            </div>
            <div class="card-body">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-secondary text-white">
                Nature of Violations ({{ selected_year }})
            </div>
            <div class="card-body">
                <canvas id="violationPieChart"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- ===============================
     MAP SECTION
================================= -->
<div class="row g-4 mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                Reports Map (Filtered)
            </div>
            <div class="card-body">
                <div id="dashboardMap" style="height:500px;"></div>
            </div>
        </div>
    </div>
</div>

</div>

<!-- ===============================
     CHART.JS
================================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===============================
   Monthly Bar Chart
================================= */
const barCtx = document.getElementById('monthlyChart');

new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: {{ months|safe }},
        datasets: [{
            label: 'Reports per Month',
            data: {{ counts|safe }},
            backgroundColor: '#0d6efd',
            borderRadius: 6
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});

/* ===============================
   Violation Pie Chart
================================= */
const pieCtx = document.getElementById('violationPieChart');

new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: {{ violation_labels|safe }},
        datasets: [{
            data: {{ violation_counts|safe }},
            backgroundColor: [
                '#0d6efd','#198754','#ffc107','#dc3545',
                '#6f42c1','#20c997','#fd7e14','#6610f2'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'right' } }
    }
});

/* ===============================
   DASHBOARD MAP
================================= */
document.addEventListener("DOMContentLoaded", function () {

    var map = L.map('dashboardMap').setView([-17.898, 31.079], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    {% for report in map_reports %}
        L.marker([{{ report.latitude }}, {{ report.longitude }}])
            .addTo(map)
            .bindPopup(`
                <strong>House:</strong> {{ report.house_number }}<br>
                <strong>Violation:</strong> {{ report.violation }}<br>
                <strong>Status:</strong> {{ report.status }}<br>
                <strong>Date:</strong> {{ report.report_date }}
            `);
    {% endfor %}

});
</script>

{% endblock %}